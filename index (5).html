<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Demand Review Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" defer></script>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121821; --muted:#1b2430; --text:#e6edf3; --sub:#9fb3c8;
      --accent:#5aa9ff; --accent2:#ffd166; --ok:#2ecc71; --warn:#ffb703; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.45 Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji';}
    header{padding:16px 18px;border-bottom:1px solid #1e2733;background:linear-gradient(180deg,#0e141b, #0b0f14)}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .wrap{padding:16px;max-width:1300px;margin:0 auto;}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.grid{grid-template-columns:1.25fr .75fr}}
    .card{background:var(--panel);border:1px solid #1b2430;border-radius:14px;padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    select{background:#0f1520;color:var(--text);border:1px solid #283141;border-radius:10px;padding:8px 12px;min-width:160px;outline:none}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .k{background:var(--muted);border-radius:12px;padding:10px 12px}
    .k h3{margin:0 0 6px 0;font-size:12px;color:var(--sub);font-weight:600;text-transform:uppercase;letter-spacing:.6px}
    .k div{font-size:22px;font-weight:700}
    .help{color:var(--sub);font-size:12px}
    .hide{display:none !important}
    .footer{opacity:.7;font-size:12px;margin-top:10px}
    .chart{height:340px}
    @media(max-width:600px){ .chart{height:260px} }
    a, a:visited { color: var(--accent2); }
  </style>
</head>
<body>
  <header>
    <h1>Demand Review Dashboard</h1>
    <div class="help">Фильтруй слева, смотри KPI и сравнивай Actual vs Forecast vs Budget. Источник: <code>data.json</code>.</div>
  </header>

  <div class="wrap">
    <div class="row" id="filters">
      <select id="region"></select>
      <select id="country"></select>
      <select id="customer"></select>
      <select id="category"></select>
      <select id="brand"></select>
      <div class="help" id="dbg"></div>
    </div>

    <div class="kpis" style="margin:12px 0 6px">
      <div class="k"><h3>Forecast Accuracy %</h3><div id="k-acc">–</div></div>
      <div class="k"><h3>Service Level %</h3><div id="k-sl">–</div></div>
      <div class="k"><h3>Δ vs Budget %</h3><div id="k-var">–</div></div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="help">Actual vs Forecast vs Budget</div>
        <div id="c-rev" class="chart"></div>
      </div>
      <div class="card" id="card-map">
        <div class="help">Service Level by Country</div>
        <div id="c-map" class="chart"></div>
      </div>

      <div class="card">
        <div class="help">Forecast Accuracy by Month (per Version)</div>
        <div id="c-acc" class="chart"></div>
      </div>
      <div class="card">
        <div class="help">Forecast Bias by Category</div>
        <div id="c-bias" class="chart"></div>
      </div>

      <div class="card" style="grid-column:1/-1">
        <div class="help">Bias Heatmap by Customer × Month</div>
        <div id="c-heat" class="chart" style="height:420px"></div>
      </div>
    </div>

    <div class="footer">v1.2 — адаптивный лэйаут, авто‑ресайз графиков, обработка ошибок загрузки JSON.</div>
  </div>

  <script>
    // дождёмся Plotly
    window.addEventListener('DOMContentLoaded', () => {
      if (typeof Plotly === 'undefined') {
        document.getElementById('dbg').textContent = 'Ошибка: Plotly не загрузился.';
        return;
      }
      init();
    });

    // --- utils ---
    const ST = { raw: [], flt: {region:"",country:"",customer:"",category:"",brand:""} };
    const num = v => (v==null||v===""||isNaN(+v))?null:+v;
    const sum = a => a.reduce((x,y)=>x+(+y||0),0);
    const avg = a => a.length? sum(a)/a.length : null;
    const uniq = a => Array.from(new Set(a.filter(Boolean))).sort();
    const by   = (a,k) => a.reduce((m,r)=>((m[r[k]||\"\"]=(m[r[k]||\"\"]||[])).push(r),m),{});
    const ymSort = list => uniq(list).sort();
    const fmtPct = x => x==null ? \"–\" : (Math.round(x*10)/10).toFixed(1);

    function applyFilters(rows){
      const f = ST.flt;
      return rows.filter(r =>
        (!f.region   || (r.region||\"\")==f.region) &&
        (!f.country  || (r.country||\"\")==f.country) &&
        (!f.customer || (r.customer||\"\")==f.customer) &&
        (!f.category || (r.category||\"\")==f.category) &&
        (!f.brand    || (r.brand||\"\")==f.brand)
      );
    }
    function setSel(id, arr, label){
      const el = document.getElementById(id);
      const val = ST.flt[id];
      el.innerHTML = \"\";
      const all = document.createElement(\"option\"); all.value=\"\"; all.textContent = label+\": All\"; el.appendChild(all);
      arr.forEach(v=>{ const o=document.createElement(\"option\"); o.value=v; o.textContent=label+\": \"+v; if(v===val) o.selected=true; el.appendChild(o); });
      el.onchange = e => { ST.flt[id] = e.target.value; render(); };
    }

    function renderKPIs(rows){
      const acc = (()=>{ const a=rows.map(r=>num(r.accuracy_pct)).filter(v=>v!=null); return a.length? avg(a) : null; })();
      const sl  = (()=>{ const a=rows.map(r=>num(r.service_level_pct)).filter(v=>v!=null); return a.length? avg(a) : null; })();
      const varp = (()=>{
        const a=rows.map(r=>num(r.revenue_var_pct_vs_budget)).filter(v=>v!=null);
        if(a.length) return avg(a);
        const x = rows.filter(r=>num(r.revenue)!=null && num(r.budget_revenue)!=null);
        if(!x.length) return null;
        const rev=sum(x.map(r=>num(r.revenue))); const bud=sum(x.map(r=>num(r.budget_revenue)));
        return bud ? (rev-bud)/bud*100 : null;
      })();
      document.getElementById(\"k-acc\").textContent = fmtPct(acc);
      document.getElementById(\"k-sl\").textContent  = fmtPct(sl);
      document.getElementById(\"k-var\").textContent = fmtPct(varp);
    }

    function renderRev(rows){
      const g=by(rows,\"yearmonth\");
      const ym=ymSort(Object.keys(g));
      const s=f=>ym.map(m=>{ const arr=(g[m]||[]).map(r=>num(r[f])).filter(v=>v!=null); return arr.length? sum(arr): null; });
      const act=s(\"revenue\"), fc=s(\"forecast_revenue\"), bud=s(\"budget_revenue\");
      const traces=[];
      if(act.some(v=>v!=null)) traces.push({x:ym,y:act,name:\"Actual\",type:\"scatter\",mode:\"lines+markers\",line:{color:\"#0E2A47\"}});
      if(fc.some(v=>v!=null))  traces.push({x:ym,y:fc,name:\"Forecast\",type:\"scatter\",mode:\"lines+markers\",line:{color:\"#6B4E3D\"}});
      if(bud.some(v=>v!=null)) traces.push({x:ym,y:bud,name:\"Budget\",type:\"scatter\",mode:\"lines+markers\",line:{color:\"#C9A244\"}});
      Plotly.newPlot(\"c-rev\", traces, {margin:{l:40,r:10,t:10,b:40},legend:{orientation:\"h\"},xaxis:{type:\"category\"},yaxis:{title:\"Revenue\"}}, {displayModeBar:false,responsive:true});
    }

    function renderMap(rows){
      const has = rows.some(r=>r.country);
      document.getElementById(\"card-map\").classList.toggle(\"hide\", !has);
      if(!has) return;
      const gb=by(rows,\"country\"); const countries=Object.keys(gb).filter(Boolean).sort();
      const rev=countries.map(c=>{ const arr=gb[c].map(r=>num(r.revenue)).filter(v=>v!=null); return arr.length? sum(arr):0; });
      const sl=countries.map(c=>{ const arr=gb[c].map(r=>num(r.service_level_pct)).filter(v=>v!=null); return arr.length? avg(arr):null; });
      Plotly.newPlot(\"c-map\", [{type:\"choropleth\", locationmode:\"country names\", locations:countries, z:sl.map(v=>v==null?0:v),
        text:countries.map((c,i)=>`${c}<br>Revenue: ${rev[i].toLocaleString()}<br>Service Level: ${sl[i]==null?\"–\":fmtPct(sl[i])+\"%\"}`),
        colorbar:{title:\"Service %\"}, colorscale:\"YlGnBu\"}],
        {margin:{l:10,r:10,t:10,b:0}}, {displayModeBar:false,responsive:true}
      );
    }

    function renderAcc(rows){
      const hasV = rows.some(r=>r.version_month);
      const groups = hasV ? by(rows,\"version_month\") : {\"Accuracy\": rows};
      const traces=[];
      Object.keys(groups).forEach(k=>{
        const g=by(groups[k],\"yearmonth\"); const ym=ymSort(Object.keys(g));
        const y=ym.map(m=>{ const arr=(g[m]||[]); const a=arr.map(r=>num(r.accuracy_pct)).filter(v=>v!=null); return a.length? avg(a): null; });
        if(y.some(v=>v!=null)) traces.push({x:ym,y,name:k,type:\"scatter\",mode:\"lines\"});
      });
      Plotly.newPlot(\"c-acc\", traces, {margin:{l:40,r:10,t:10,b:40},legend:{orientation:\"h\"},yaxis:{title:\"Accuracy %\"},xaxis:{type:\"category\"}}, {displayModeBar:false,responsive:true});
    }

    function renderBias(rows){
      const gb=by(rows,\"category\"); const cats=Object.keys(gb).filter(Boolean);
      const ys=cats.map(c=>{ const arr=gb[c]; const b=arr.map(r=>num(r.bias_pct)).filter(v=>v!=null); return b.length? avg(b):null; });
      const X=[],Y=[]; cats.forEach((c,i)=>{ if(ys[i]!=null){X.push(c);Y.push(ys[i]);} });
      Plotly.newPlot(\"c-bias\", [{x:X,y:Y,type:\"bar\",marker:{color:\"#6B4E3D\"}}], {margin:{l:40,r:10,t:10,b:80},xaxis:{tickangle:-30},yaxis:{title:\"Bias %\"}}, {displayModeBar:false,responsive:true});
    }

    function renderHeat(rows){
      const byC=by(rows,\"customer\"); const customers=Object.keys(byC).filter(Boolean).sort();
      const months=ymSort(rows.map(r=>r.yearmonth).filter(Boolean));
      const Z=customers.map(c=>{ const g=by(byC[c],\"yearmonth\"); return months.map(m=>{ const a=(g[m]||[]); const b=a.map(r=>num(r.bias_pct)).filter(v=>v!=null); const v=b.length? avg(b):0; return v==null?0:v; }); });
      Plotly.newPlot(\"c-heat\", [{z:Z,x:months,y:customers,type:\"heatmap\",colorscale:\"RdBu\",reversescale:true,zmid:0,colorbar:{title:\"Bias %\"}}], {margin:{l:120,r:20,t:10,b:60}}, {displayModeBar:false,responsive:true});
    }

    function fillFilters(rows){
      setSel(\"region\",  uniq(rows.map(r=>r.region)),  \"Region\");
      setSel(\"country\", uniq(rows.map(r=>r.country)), \"Country\");
      setSel(\"customer\",uniq(rows.map(r=>r.customer)),\"Customer\");
      setSel(\"category\",uniq(rows.map(r=>r.category)),\"Category\");
      setSel(\"brand\",   uniq(rows.map(r=>r.brand)),   \"Brand\");
    }

    function render(){
      const rows = applyFilters(ST.raw);
      document.getElementById(\"dbg\").textContent = \"Строк: \"+rows.length;
      renderKPIs(rows); renderRev(rows); renderMap(rows); renderAcc(rows); renderBias(rows); renderHeat(rows);
      setTimeout(()=>{ ['c-rev','c-map','c-acc','c-bias','c-heat'].forEach(id=>{const el=document.getElementById(id); if(el) Plotly.Plots.resize(el);}); }, 60);
    }

    (function(){ // throttled resize
      let t; window.addEventListener('resize', ()=>{ clearTimeout(t); t=setTimeout(()=>{ ['c-rev','c-map','c-acc','c-bias','c-heat'].forEach(id=>{const el=document.getElementById(id); if(el) Plotly.Plots.resize(el);}); }, 120); });
    })();

    async function init(){
      try{
        const res = await fetch('data.json', {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        ST.raw = await res.json();
        fillFilters(ST.raw);
        render();
      }catch(err){
        console.error(err);
        document.getElementById('dbg').textContent = 'Ошибка загрузки data.json: ' + err.message + ' — положи файл рядом с index.html в репозитории.';
      }
    }
  </script>
</body>
</html>
